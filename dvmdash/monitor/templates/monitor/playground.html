{% extends 'monitor/base.html' %}
{% load static %}

{% block title %}Playground{% endblock %}

{% block extrahead %}
    <script src="{% static 'js/bundle.js' %}"></script>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="form-container">
            <div class="form-group">
                <textarea id="eventContent" class="form-control" rows="3" placeholder="Enter a message here"></textarea>
            </div>
            <button id="sendButton" class="btn btn-primary" disabled>Send Data Vending Machine Event</button>
        </div>
        <div id="responses" class="mt-4">
            <h3>Activity:</h3>
            <ul id="responseList"></ul>
        </div>
        <div id="relayStatus" class="mt-4">
            <h3>Relay Statuses:</h3>
        </div>
        <div id="errorMessages" class="mt-4 text-danger"></div>
    </div>

    <script>
        const relays = [
            'wss://nostr-pub.wellorder.net',
            'wss://relay.damus.io',
            'wss://nos.lol',
            'wss://relay.primal.net',
            'wss://offchain.pub',
            'wss://nostr.mom',
            'wss://relay.nostr.bg',
            'wss://nostr.oxtr.dev',
            'wss://nostr-relay.nokotaro.com',
            'wss://relay.nostr.wirednet.jp'
        ];

        let ndk;
        let user;
        let signer;
        let userProfile;

        async function initNostr() {
            console.log('Starting Nostr initialization');
            try {
                console.log('NDK object:', NDK);
                const nip07signer = new NDKNip07Signer();
                console.log('NDKNip07Signer object:', nip07signer);

                ndk = new NDK({
                    explicitRelayUrls: relays,
                    signer: nip07signer
                });

                console.log('Connecting to NDK...');
                await ndk.connect();
                console.log('Connected to NDK');

                console.log('NDK instance created:', ndk);

                console.log('About to call nip07signer.user()');
                await nip07signer.user().then(async (user) => {
                    if (!!user.npub) {
                        console.log("Permission granted to read their public key:", user.npub);
                        signer = nip07signer;
                        startListeningForEvents();
                    } else {
                        console.log("Permission denied to read their public key");
                    }
                });

                console.log('About to fetch user profile');
                try {
                    user = await nip07signer.user();
                    userProfile = await user.fetchProfile();
                    console.log('User profile:', userProfile);

                    if (userProfile) {
                        console.log(`Fetched profile for ${userProfile.name || 'unnamed user'}`);
                    } else {
                        console.log('No profile found for user');
                    }
                } catch (error) {
                    console.error('Error fetching user profile:', error);
                }
                
                updateRelayStatus();
                document.getElementById('sendButton').disabled = false;
            } catch (error) {
                console.error('Error initializing Nostr:', error);
                document.getElementById('errorMessages').textContent = `Error initializing Nostr: ${error.message}`;
            }
        }

        function startListeningForEvents() {
            console.log('Starting to listen for events');
            const filter = { kinds: [7000] };  // Only listen for kind 7000 events
            console.log('Subscription filter:', filter);

            const subscription = ndk.subscribe(filter, (event) => {
                console.log('Received event:', JSON.stringify(event, null, 2));
                console.log('Event kind:', event.kind);
                console.log('Event tags:', JSON.stringify(event.tags, null, 2));
                console.log('Event content:', event.content);

                if (event.kind === 7000) {
                    console.log('Received a kind 7000 event');
                    const li = document.createElement('li');
                    li.textContent = `Feedback from ${event.pubkey.slice(0, 8)}...: ${event.content}`;
                    document.getElementById('responseList').appendChild(li);
                } else {
                    console.log('Received an event with unexpected kind:', event.kind);
                }
            });

            console.log('Subscription created:', subscription);
        }

        async function sendEvent() {
            const content = document.getElementById('eventContent').value;
            try {
                const event = new NDKEvent(ndk);
                event.kind = 5050;
                event.content = content;

                await event.sign(signer);
                await ndk.publish(event);
                console.log('Data Vending Machine Event published:', event);
                console.log('Event ID:', event.id);

                const li = document.createElement('li');
                if (userProfile) {
                    li.textContent = `${userProfile.name} published '${event.content}' from ${event.pubkey.slice(0, 8)}`;
                } else {
                    li.textContent = `User published '${event.content}' from ${event.pubkey.slice(0, 8)}`;
                }
                document.getElementById('responseList').appendChild(li);

            } catch (error) {
                console.error('Failed to publish event:', error);
                document.getElementById('errorMessages').textContent = `Failed to publish event: ${error.message}`;
            }
        }

        function updateRelayStatus() {
            const statusDiv = document.getElementById('relayStatus');
            statusDiv.innerHTML = '<h3>Relay Statuses:</h3>';
            ndk.pool.relays.forEach(relay => {
                const status = relay.status;
                const li = document.createElement('li');
                li.textContent = `${relay.url}: ${status}`;
                statusDiv.appendChild(li);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initNostr().catch(error => {
                console.error('Error in DOMContentLoaded:', error);
                document.getElementById('errorMessages').textContent = `Error in page load: ${error.message}`;
            });
            document.getElementById('sendButton').addEventListener('click', sendEvent);
        });
    </script>
{% endblock %}