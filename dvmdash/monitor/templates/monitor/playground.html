{% extends 'monitor/base.html' %}
{% load static %}

{% block title %}Playground{% endblock %}

{% block extrahead %}
    <script src="{% static 'js/bundle.js' %}"></script>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="form-container">
            <div class="form-group">
                <textarea id="eventContent" class="form-control" rows="3" placeholder="Enter a message here"></textarea>
            </div>
            <button id="sendButton" class="btn btn-primary" disabled>Send Data Vending Machine Event</button>
        </div>
        <div id="responses" class="mt-4">
            <h3>Activity:</h3>
            <ul id="responseList"></ul>
        </div>
        <div id="relayStatus" class="mt-4">
            <h3>Relay Statuses:</h3>
        </div>
        <div id="errorMessages" class="mt-4 text-danger"></div>
    </div>

    <script>
        const relays = [
            'wss://nostr-pub.wellorder.net',
            'wss://relay.damus.io',
            'wss://nos.lol',
            'wss://relay.primal.net',
            'wss://offchain.pub',
            'wss://nostr.mom',
            'wss://relay.nostr.bg',
            'wss://nostr.oxtr.dev',
            'wss://nostr-relay.nokotaro.com',
            'wss://relay.nostr.wirednet.jp'
        ];

        let ndk;
        let user;
        let signer;

        async function initNostr() {
            try {
                console.log('NDK object:', NDK);
                const nip07signer = new NDKNip07Signer();

                ndk = new NDK({
                    explicitRelayUrls: relays,
                    signer: nip07signer
                });

                console.log('NDK instance created:', ndk);

                await nip07signer.user().then(async (user) => {
                    if (!!user.npub) {
                        console.log("Permission granted to read their public key:", user.npub);
                        signer = nip07signer;
                        startListeningForEvents();
                    } else {
                        console.log("Permission denied to read their public key");
                    }
                });

                console.log('Connecting to NDK...');
                await ndk.connect();
                console.log('Connected to NDK');

                updateRelayStatus();
                document.getElementById('sendButton').disabled = false;
            } catch (error) {
                console.error('Error initializing Nostr:', error);
                document.getElementById('errorMessages').textContent = `Error initializing Nostr: ${error.message}`;
            }
        }

        function startListeningForEvents() {
            console.log('Starting to listen for events');
            const filter = { kinds: [7000, 6050] };
            console.log('Subscription filter:', filter);

            const subscription = ndk.subscribe(filter, (event) => {
                console.log('Received event:', event);
                console.log('Event tags:', event.tags);

                // Process all events of kind 7000 and 6050
                const kindLabel = event.kind === 7000 ? 'Feedback' : 'Response';
                const li = document.createElement('li');
                const status_tag = event.tags.find(tag => tag.startsWith('status:'));
                li.textContent = `${kindLabel} from ${event.pubkey.slice(0, 8)}...: ${status_tag}`;
                document.getElementById('responseList').appendChild(li);
            });

            console.log('Subscription created:', subscription);
        }

        async function sendEvent() {
            const content = document.getElementById('eventContent').value;
            try {
                const event = new NDKEvent(ndk);
                event.kind = 5050;
                event.content = content;

                await event.sign(signer);
                await ndk.publish(event);
                console.log('Data Vending Machine Event published:', event);
                console.log('Event ID:', event.id);

                const li = document.createElement('li');
                li.textContent = `Published '${event.content}' from ${event.pubkey.slice(0, 8)}`;
                document.getElementById('responseList').appendChild(li);

            } catch (error) {
                console.error('Failed to publish event:', error);
                document.getElementById('errorMessages').textContent = `Failed to publish event: ${error.message}`;
            }
        }

        function updateRelayStatus() {
            const statusDiv = document.getElementById('relayStatus');
            statusDiv.innerHTML = '<h3>Relay Statuses:</h3>';
            ndk.pool.relays.forEach(relay => {
                const status = relay.status;
                const li = document.createElement('li');
                li.textContent = `${relay.url}: ${status}`;
                statusDiv.appendChild(li);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initNostr().catch(error => {
                console.error('Error in DOMContentLoaded:', error);
                document.getElementById('errorMessages').textContent = `Error in page load: ${error.message}`;
            });
            document.getElementById('sendButton').addEventListener('click', sendEvent);
        });
    </script>
{% endblock %}